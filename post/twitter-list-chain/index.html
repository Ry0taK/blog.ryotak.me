<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.75.1"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Twitterの非公開リストが見れた話 - RyotaK's Blog</title><meta name=author content="RyotaK"><meta name=description content="技術的な話とか"><meta property="og:title" content="Twitterの非公開リストが見れた話"><meta property="og:description" content="はじめに TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性診断を行うことが認められています。 本記事は、そのプログラムを通して報告された脆弱性についてを解"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.ryotak.me/post/twitter-list-chain/"><meta property="og:image" content="https://blog.ryotak.me/img/og.webp"><meta property="article:published_time" content="2020-10-09T18:00:00+09:00"><meta property="article:modified_time" content="2020-10-09T18:00:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://blog.ryotak.me/img/og.webp"><meta name=twitter:title content="Twitterの非公開リストが見れた話"><meta name=twitter:description content="はじめに TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性診断を行うことが認められています。 本記事は、そのプログラムを通して報告された脆弱性についてを解"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://blog.ryotak.me/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');if(!fujiThemeData){localStorage.setItem('fuji_data-theme','auto');}else{if(fujiThemeData!=='auto'){document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light');}}</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://blog.ryotak.me>RyotaK's Blog</a>
<span class=title-sub>技術的な話とか</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://blog.ryotak.me/post/twitter-list-chain/>Twitterの非公開リストが見れた話</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2020-10-09</span><span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;2086 字</span><span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;タグはありません</span></div><div class="post-content markdown-body"><h2 id=はじめに>はじめに</h2><p>TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性診断を行うことが認められています。<br>本記事は、そのプログラムを通して報告された脆弱性についてを解説したものであり、インターネット上のサービスに無差別に攻撃する事を推奨するものではありません。<br>また、Twitter上で脆弱性を発見した場合は無闇に公開せず、<a href=https://hackerone.com/twitter target=_blank>TwitterのBug Bountyプログラム</a>より報告してください。</p><h2 id=要約>要約</h2><p>不適切なアクセス制御とレートリミットの欠如、タイミング攻撃を組み合わせることによりTwitterの非公開リストの中身を閲覧できた。</p><h2 id=不適切なアクセス制御>不適切なアクセス制御</h2><p>TwitterのGraphQLエンドポイントに対して以下のようなリクエストを送信すると、リストが非公開であったとしてもリストのメンバーリストを取得することが出来た。</p><pre><code class=language-http>GET /graphql/iUmNRKLdkKVH4WyBNw9x2A/ListMembers?variables=%7B%22listId%22%3A%22[ここにリストID]%22%2C%22count%22%3A20%2C%22withTweetResult%22%3Afalse%2C%22withUserResult%22%3Afalse%7D HTTP/1.1
Host: api.twitter.com
User-Agent: [Redacted]
Accept: */*
Accept-Language: ja,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
content-type: application/json
x-twitter-auth-type: OAuth2Session
x-twitter-client-language: ja
x-twitter-active-user: yes
x-csrf-token: [Redacted]
Origin: https://twitter.com
authorization: Bearer [Redacted]
Connection: close
Cookie: [Redacted]


</code></pre><p>リストのIDが取得できれば非公開リストの内容が読み取れる状態だったので報告したが、Twitter曰く非公開リストのIDを取得するのは困難らしく、それを回避しない限り潜在的な脆弱性でしか無いと拒否されそうになった。<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p><img class=img-zoomable src=/img/twitter-needmoreinfo-listid.png alt=Twitterチームの返信画像>
しかしながら、TwitterのIDは<code>ミリ秒単位のタイムスタンプ</code>、<code>Worker ID</code>、<code>データセンターID</code>、<code>ID衝突回避用の値</code>で構成されており、そのうち<code>ID衝突回避用の値</code>は0始まりで衝突するたびに加算されていく物で、かつ<code>データセンターID</code>は基本的に10であるため、<code>ミリ秒単位のタイムスタンプ</code>と<code>Worker ID</code>を推測することができれば実質的にIDがわかる。<br>攻撃は現実的であるということを証明する必要があったため、更に調査することにした。</p><h2 id=レートリミットの欠如>レートリミットの欠如</h2><p>非公開リストのIDを取得する方法を探していた際に、Twitter APIの一部のレートリミットが、ドキュメント上には存在すると書いてあるにも関わらず、実際には存在しないことがわかった。<br>それらのエンドポイントの一つに<a href=https://developer.twitter.com/en/docs/twitter-api/v1/accounts-and-users/create-manage-lists/api-reference/post-lists-destroy target=_blank><code>POST /1.1/lists/destroy.json</code></a>が存在した。<br>このエンドポイントは、リストを削除するためのエンドポイントなのだが、当然他人の非公開リストを削除しようとしたとしても404が帰ってくるだけだった。</p><pre><code class=language-http>POST /1.1/lists/destroy.json
Content-Type: application/x-www-form-urlencoded
Authorization: OAuth [Redacted]

list_id=[ここにリストID]
</code></pre><h2 id=タイミング攻撃>タイミング攻撃</h2><p>前述のエンドポイントを詳しく調べている際に、TwitterのAPIにリクエストを送った際に帰ってくるレスポンスのほぼ全てに<code>x-response-time</code>というヘッダが存在していることがわかった。<br>確認した所、このヘッダはTwitter API内部で処理にかかった時間を正確に返しているようだった。<br>ここまで露骨な前振りをされたらタイミング攻撃しか無いだろうということで試してみた所、他人の非公開リストの削除を試みた場合と存在しないリストの削除を試みた場合とで<code>x-response-time</code>の値に～20程の差異が存在した。<br>これと前述のレートリミットの欠如を組み合わせることにより、非公開リストのIDを現実的な時間内で総当りすることが可能となり、それを報告した所無事にTwitterのセキュリティチームによりトリアージされた。</p><h2 id=まとめ>まとめ</h2><p>Twitterのトリアージチームがこの脆弱性を調査している間、非公開リストのメンバーリストを取得できるのは「Bug Bountyプログラムで扱うほどのリスクではない」という返信が帰ってくるなど、拒否されそうになる場面が何度かあったが、根気良く説明した事により脆弱性として認められた。<br>一度拒否することが確定した物<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>でも、セキュリティ上の問題が明確なものに関してはなぜ問題なのかを説明することが重要で、それによって一転して脆弱性であると認めることがあるため、今後Twitterに脆弱性を報告する人はその点を留意したほうが良いかもしれない。</p><h2 id=タイムライン>タイムライン</h2><table><thead><tr><th>日付</th><th>出来事</th></tr></thead><tbody><tr><td>2020/5/29</td><td>脆弱性を報告</td></tr><tr><td>2020/5/30</td><td>Twitter: 更に情報が必要</td></tr><tr><td>2020/5/30</td><td>追加の情報を送信</td></tr><tr><td>2020/6/1</td><td>Twitter: 更に情報が必要</td></tr><tr><td>2020/6/2</td><td>追加の情報を送信</td></tr><tr><td>2020/6/2</td><td>Twitter: 内部調査中</td></tr><tr><td>2020/6/6</td><td>Twitter: 脆弱性として認定</td></tr><tr><td>2020/6/24</td><td>Twitter: 報奨金額の決定</td></tr><tr><td>2020/8/1</td><td>Twitter: 脆弱性を修正</td></tr><tr><td>2020/8/4</td><td>脆弱性の開示</td></tr></tbody></table><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>後のレポートでIDを取得することは容易であるとTwitterチームが認めたが、直近のレポートでもトリアージチームはIDを取得する方法が無いという理由で拒否しようとしてくる。 <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>例として、限定公開のコンテンツのURLが推測出来るということを報告したらそれは脆弱性ではなく仕様であるとされたことや、非公開ツイートの一部データが取得できる事を報告したらそれはBug Bountyプログラムで扱うほどのリスクではないとされたこと等がある。 <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>ページ</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/about/>About</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>タグ</h3><div></div></div><div class="sidebar-item sidebar-links"><h3>リンク</h3><ul><li><a href=https://twitter.com/ryotkak target=_blank><span>Twitter</span></a></li><li><a href=https://github.com/Ry0taK target=_blank><span>GitHub</span></a></li></ul></div></aside></div><div class=btn><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2020 <a href=https://blog.ryotak.me>RyotaK</a> |
Powered by <a href=https://github.com/amzrk2/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/combine/npm/medium-zoom@1.0.6,npm/lazysizes@5.2.2></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script></body></html>