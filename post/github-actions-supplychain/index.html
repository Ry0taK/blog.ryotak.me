<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.80.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>GitHub Actionsにおけるサプライチェーン攻撃を介したリポジトリ侵害 - RyotaK's Blog</title><meta name=author content="RyotaK"><meta name=description content="技術的な話とか"><meta name=keywords content="GitHub,脆弱性,GitHub Actions,Supply Chain"><meta property="og:title" content="GitHub Actionsにおけるサプライチェーン攻撃を介したリポジトリ侵害"><meta property="og:description" content="はじめに GitHubはBug Bountyプログラムを実施しており、その一環として脆弱性の診断行為をセーフハーバーにより許可しています。 本記事は、そのセーフハーバーの基準を遵守した上で調査を行い、結果を"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.ryotak.me/post/github-actions-supplychain/"><meta property="og:image" content="https://blog.ryotak.me/img/og.webp"><meta property="article:published_time" content="2021-02-25T12:30:00+09:00"><meta property="article:modified_time" content="2021-02-25T12:30:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://blog.ryotak.me/img/og.webp"><meta name=twitter:title content="GitHub Actionsにおけるサプライチェーン攻撃を介したリポジトリ侵害"><meta name=twitter:description content="はじめに GitHubはBug Bountyプログラムを実施しており、その一環として脆弱性の診断行為をセーフハーバーにより許可しています。 本記事は、そのセーフハーバーの基準を遵守した上で調査を行い、結果を"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://blog.ryotak.me/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');if(!fujiThemeData){localStorage.setItem('fuji_data-theme','auto');}else{if(fujiThemeData!=='auto'){document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light');}}</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://blog.ryotak.me>RyotaK's Blog</a>
<span class=title-sub>技術的な話とか</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://blog.ryotak.me/post/github-actions-supplychain/>GitHub Actionsにおけるサプライチェーン攻撃を介したリポジトリ侵害</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-02-25</span><span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;3292 字</span><span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/github>GitHub</a>&nbsp;<a href=/tags/%E8%84%86%E5%BC%B1%E6%80%A7>脆弱性</a>&nbsp;<a href=/tags/github-actions>GitHub Actions</a>&nbsp;<a href=/tags/supply-chain>Supply Chain</a>&nbsp;</span></div><div class="post-content markdown-body"><h2 id=はじめに>はじめに</h2><p>GitHubはBug Bountyプログラムを実施しており、その一環として脆弱性の診断行為を<a href=https://docs.github.com/en/github/site-policy/github-bug-bounty-program-legal-safe-harbor target=_blank>セーフハーバー</a>により許可しています。<br>本記事は、そのセーフハーバーの基準を遵守した上で調査を行い、結果をまとめたものであり、無許可の脆弱性診断行為を推奨することを意図したものではありません。<br>GitHub上で脆弱性を発見した場合は、<a href="https://hackerone.com/github?type=team" target=_blank>GitHub Security Bug Bounty</a>へ報告してください。</p><h2 id=要約>要約</h2><p>GitHub Actionsの仕様上、デフォルトではサプライチェーン攻撃に対する適切な保護が行われないため、特定の条件を満たしたリポジトリを侵害することが出来る。<br>この問題の影響を受けるリポジトリがどの程度存在するかを調査した所、<a href=https://github.com/Jguer/yay target=_blank>yay</a>等の広く使われているソフトウェアのリポジトリを含めた多数のリポジトリがこの攻撃に対して脆弱であることがわかった。</p><h2 id=調査理由>調査理由</h2><p><a href=https://blog.utgw.net/entry/2021/02/05/133642 target=_blank>GitHub Actionsを使ったDDoSに巻き込まれた</a>という記事を読み、以前から調査したいと考えていたサプライチェーン攻撃に関連した調査をGitHub Actionsで行うことを思いついたため、調査内容を考え初めた。<br>過去に<a href=https://blog.securityinnovation.com/repo-jacking-exploiting-the-dependency-supply-chain target=_blank>Repo Jacking: Exploiting the Dependency Supply Chain</a>という記事を読んでおり、追加の検証無しにリポジトリを直接参照している場合、サプライチェーン攻撃が刺さりやすくなる事を知っていたため、GitHub Actionsの<a href=https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstepsuses target=_blank><code>uses</code>構文</a>が同様の挙動をするかどうか確認した。<br>その結果、同様の挙動をすることがわかったため、本調査を実施することにした。</p><h2 id=脆弱なサプライチェーン>脆弱なサプライチェーン</h2><p>GitHub Actionsには、<code>uses</code>という他のユーザーが作成したActionのリポジトリを指定し、ワークフロー内に組み込むことが出来る構文が存在する。<br>この機能では、デフォルトで整合性チェックが行われておらず、結果として参照先のActionが改竄されていたとしても正常に処理が実行されてしまう。<br>参照先のActionが書き換えられた場合、ワークフローの発火元のイベントが<code>pull_request</code>以外であれば<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>、Action側が参照するシークレットを指定できるため<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>、書き込み権限を持つ<code>GITHUB_TOKEN</code>の窃取に繋がり、結果としてリポジトリを侵害することが可能となる。<br>これは、サプライチェーンの保護という観点においては推奨されるものではない。 (例として、<a href=https://www.usenix.org/sites/default/files/conference/protected-files/enigma2020_slides_valsorda.pdf target=_blank>Goでは依存関係の整合性チェックを行っている。</a>)</p><p><img class=img-zoomable src=/img/github-actions-simple.png alt="GitHub Actionsのワークフロー内で参照したActionが悪意あるものだった時の画像"></p><h2 id=githubのリポジトリリダイレクト>GitHubのリポジトリリダイレクト</h2><p>また、この問題を深刻化させている機能に、<a href=https://github.blog/2013-05-16-repository-redirects-are-here/ target=_blank>リポジトリリダイレクト</a>が挙げられる。<br>これは、リポジトリのオーナーがリポジトリ名やユーザー名を変更した後、元のユーザー名とリポジトリ名を使用した参照を行う際に自動でリダイレクトする機能で、これによりActionを提供している開発者がGitHubのユーザー名を変更した後も、そのActionを使用しているワークフローは動作し続ける。</p><p><img class=img-zoomable src=/img/github-actions-redir.png alt="GitHub Actionsにおけるリポジトリリダイレクトの動作方法の画像"></p><p>しかしながら、このリダイレクトは攻撃者が簡単に制御することが可能となっている。<br>攻撃者は、リポジトリオーナーの元々のIDを取得し、同名のリポジトリを作成することによりこのリダイレクトを止め、攻撃者が制御するリポジトリを参照するように変更することができる。<br><img class=img-zoomable src=/img/github-actions-compromised.png alt="GitHub Actionsにおいて、攻撃者がリポジトリリダイレクトを制御している画像"></p><p>これにより、Actionを公開している開発者がユーザー名を変更した後、ワークフローが参照しているActionが移動したことに気がつけず、長期間に渡ってリポジトリが脆弱な状況に置かれる可能性が高まる。</p><h2 id=調査>調査</h2><p>前述の通り、Actionを公開している開発者がユーザー名を変更した後、それが検出されずに放置されている可能性がある程度存在する。<br>その状態になっているリポジトリを検出するため、以下の検索クエリにマッチするワークフローファイルの取得を<a href=https://docs.github.com/en/rest/reference/search#search-code target=_blank>コード検索API</a>から試みた。</p><pre><code>path:.github/workflows language:yaml uses
</code></pre><p>調査時点で919,249件のファイルが上記の条件にマッチしたが、GitHubは検索結果の最初の1000件のみを返すため、全件取得ができない。<br>そのため、<a href=https://docs.github.com/en/github/searching-for-information-on-github/searching-code#search-by-file-size target=_blank><code>size</code>クエリパラメータ</a>を用い、検索APIから取得できるデータ数を可能な限り増やした。<br>これにより、810,177件のワークフローを取得することができた。</p><p>また、このエンドポイントはファイルの内容をレスポンスに含めないため、ワークフローを解析するためには別のエンドポイントを叩く必要があった。<br>しかしながら、810,177件のファイルを普通に取得しようとすると、APIのレートリミットによりかなりの時間がかかり、現実的な時間内に終わらない可能性がある。<br>そこで、<a href=https://docs.github.com/en/graphql target=_blank>GraphQL API</a>を用いて、一回のリクエストで200個ほどのクエリを実行することによりこの問題を解決した。</p><pre><code>query{
	query1: repository(owner:&quot;owner_name&quot;,name:&quot;repository_name&quot;){
		content: object(expression:&quot;ref:filepath&quot;){
			... on Blob{
				text
			}
		}
	}
	query2: repository(owner:&quot;owner_name&quot;,name:&quot;repository_name&quot;){
		content: object(expression:&quot;ref:filepath&quot;){
			... on Blob{
				text
			}
		}
	}
	...
}
</code></pre><p>それぞれのワークフローを簡単なスクリプトで解析した結果、以下のような内訳になった。</p><table><thead><tr><th>件数</th><th>概要</th></tr></thead><tbody><tr><td>699170</td><td><code>actions/</code>のActionを除いたユニークな<code>uses</code></td></tr><tr><td>5462</td><td>無効なYAML形式</td></tr></tbody></table><p>この結果を元に、Action所有者のユーザー名が存在するかどうかを確認した。<br>ユーザーの存在確認は、以下のGraphQLクエリを実行し、結果がnullであれば存在しないといった形で確認することができる。</p><pre><code>query{
	repositoryOwner(login:&quot;owner_id&quot;){
		id
	}
}
</code></pre><p>結果として、118個のユーザー名が一つ以上のワークフローにより使用されているにも関わらず、登録可能な状態になっている事がわかった。 (これらのユーザー名はGitHubによって保護される予定となっている。<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>)<br>これらのユーザーが公開しているActionを使用しているリポジトリを調べた所、AUR Helperの<a href=https://github.com/Jguer/yay target=_blank>yay</a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>等、有名なリポジトリを含む多くのリポジトリに影響を及ぼしていた。<br>また、プライベートリポジトリが普及している現状を考えると、この問題は今回判明した以上の影響を持っていると考えられる。</p><h2 id=軽減策>軽減策</h2><p>この問題は、ユーザーによりある程度軽減することができる。<br>以下に軽減策を効果が高いと思われる順番に並べた。</p><ol><li>Actionをワークフローと同じリポジトリに含める: ユーザー名の変更などにより影響を受けず、Actionを書き換えることが可能なユーザーであれば直接ワークフローを変更できるため、これは最も効果的な軽減策だと思われる。</li><li>Actionをフォークし、フォークした物をワークフローから参照する: 他のユーザーの名前変更による影響を受けなくなる軽減策だが、自分がユーザー名を変更した際にワークフローの書き換えを忘れると依然として脆弱になる。</li><li>Actionの指定をコミットハッシュと共に行う: これは、<a href=https://security.googleblog.com/2017/02/announcing-first-sha1-collision.html target=_blank>GoogleがSHA-1の衝突に成功した</a>ことを考えると、完全に安全な軽減策ではないと考えられる。しかしながら、依然として攻撃を困難にすることが可能となる。</li></ol><h2 id=まとめ>まとめ</h2><p>今回の記事では、GitHub Actionsの仕様上の問題がどのようにしてリポジトリの侵害につながるかと、その影響範囲の調査結果を紹介しました。<br>この問題に関しては、GitHubにも報告しましたが、「将来的に挙動を変更する計画はあるが、現時点でそれ以上の情報はない」という返信が来たため、現在の所ユーザーが適切な設定を行うことが重要となっています。<br>もしこの記事を読んでいる方がGitHub Actionsを使用しており、かつ<code>uses</code>構文を用いて他人のActionを使用している場合は、今一度設定を見直して欲しいと思います。</p><p>本記事に関する質問はTwitter(<a href=https://twitter.com/ryotkak target=_blank>@ryotkak</a>)へメッセージを投げてください。</p><h2 id=タイムライン>タイムライン</h2><table><thead><tr><th>日付</th><th>出来事</th></tr></thead><tbody><tr><td>2021/02/05 22:48</td><td>ファイル一覧取得開始</td></tr><tr><td>2021/02/06 07:05</td><td>ファイル一覧取得完了</td></tr><tr><td>2021/02/07 10:08</td><td>ファイル内容の取得並びに解析開始</td></tr><tr><td>2021/02/07 18:24</td><td>ファイル内容の取得並びに解析完了</td></tr><tr><td>2021/02/07 19:11</td><td>ユーザーの存在状況確認開始</td></tr><tr><td>2021/02/07 19:58</td><td>ユーザーの存在状況確認完了</td></tr><tr><td>2021/02/08 18:43</td><td>影響を受けるリポジトリの特定</td></tr><tr><td>2021/02/08 22:21</td><td>GitHubに問題の報告と開示許可の要請</td></tr><tr><td>2021/02/12 02:24</td><td>GitHubからの返信並びに開示許可が出る</td></tr><tr><td>2021/02/25 12:30</td><td>本記事の公開</td></tr></tbody></table><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://docs.github.com/en/actions/reference/authentication-in-a-workflow#permissions-for-the-github_token>https://docs.github.com/en/actions/reference/authentication-in-a-workflow#permissions-for-the-github_token</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://github.com/actions/checkout/blob/61b9e3751b92087fd0b06925ba6dd6314e06f089/action.yml#L12-L24>https://github.com/actions/checkout/blob/61b9e3751b92087fd0b06925ba6dd6314e06f089/action.yml#L12-L24</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>記事公開より前にGitHubがこれらのユーザー名の保護を行うはずだったが、なぜか現時点で保護されていないため、ユーザー名一覧並びにリポジトリ一覧の公開ができなかった。 <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://github.com/Jguer/yay/issues/1468>https://github.com/Jguer/yay/issues/1468</a> <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>ページ</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/about/>About</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>タグ</h3><div><span><a href=/tags/brute-force/>Brute Force</a></span>
<span><a href=/tags/bug-bounty/>Bug Bounty</a></span>
<span><a href=/tags/fleet/>Fleet</a></span>
<span><a href=/tags/github/>GitHub</a></span>
<span><a href=/tags/github-actions/>GitHub Actions</a></span>
<span><a href=/tags/idor/>IDOR</a></span>
<span><a href=/tags/microsoft/>Microsoft</a></span>
<span><a href=/tags/privilege-escalation/>Privilege Escalation</a></span>
<span><a href=/tags/rce/>RCE</a></span>
<span><a href=/tags/supply-chain/>Supply Chain</a></span>
<span><a href=/tags/timing-attack/>Timing Attack</a></span>
<span><a href=/tags/twitter/>Twitter</a></span>
<span><a href=/tags/vscode/>VSCode</a></span>
<span><a href=/tags/%E8%84%86%E5%BC%B1%E6%80%A7/>脆弱性</a></span></div></div><div class="sidebar-item sidebar-links"><h3>リンク</h3><ul><li><a href=https://twitter.com/ryotkak target=_blank><span>Twitter</span></a></li><li><a href=https://github.com/Ry0taK target=_blank><span>GitHub</span></a></li></ul></div></aside></div><div class=btn><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021 <a href=https://blog.ryotak.me>RyotaK</a> |
Powered by <a href=https://github.com/amzrk2/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/combine/npm/medium-zoom@1.0.6,npm/lazysizes@5.2.2></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script></body></html>