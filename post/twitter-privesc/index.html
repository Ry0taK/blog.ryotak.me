<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.80.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Twitterのフリート機能に対する権限昇格 - RyotaK's Blog</title><meta name=author content="RyotaK"><meta name=description content="技術的な話とか"><meta name=keywords content="Twitter,Fleet,Privilege Escalation,Bug Bounty"><meta property="og:title" content="Twitterのフリート機能に対する権限昇格"><meta property="og:description" content="はじめに TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性の診断行為を行うことが認められています。 本記事は、そのプログラムを通して報告された脆弱性につい"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.ryotak.me/post/twitter-privesc/"><meta property="og:image" content="https://blog.ryotak.me/img/og.webp"><meta property="article:published_time" content="2021-01-05T14:00:00+09:00"><meta property="article:modified_time" content="2021-01-05T14:00:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://blog.ryotak.me/img/og.webp"><meta name=twitter:title content="Twitterのフリート機能に対する権限昇格"><meta name=twitter:description content="はじめに TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性の診断行為を行うことが認められています。 本記事は、そのプログラムを通して報告された脆弱性につい"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://blog.ryotak.me/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');if(!fujiThemeData){localStorage.setItem('fuji_data-theme','auto');}else{if(fujiThemeData!=='auto'){document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light');}}</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://blog.ryotak.me>RyotaK's Blog</a>
<span class=title-sub>技術的な話とか</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://blog.ryotak.me/post/twitter-privesc/>Twitterのフリート機能に対する権限昇格</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-01-05</span><span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;2158 字</span><span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/twitter>Twitter</a>&nbsp;<a href=/tags/fleet>Fleet</a>&nbsp;<a href=/tags/privilege-escalation>Privilege Escalation</a>&nbsp;<a href=/tags/bug-bounty>Bug Bounty</a>&nbsp;</span></div><div class="post-content markdown-body"><h2 id=はじめに>はじめに</h2><p>TwitterはBug Bountyプログラム(脆弱性報奨金制度とも呼ばれる)を実施しており、脆弱性の診断行為を行うことが認められています。<br>本記事は、そのプログラムを通して報告された脆弱性についてを解説したものであり、Twitterが認知していない未修正の脆弱性を公開する事を意図したものではありません。<br>また、Twitter上で脆弱性を発見した場合は<a href=https://hackerone.com/twitter target=_blank>TwitterのBug Bountyプログラム</a>より報告してください。</p><p>(This article is written in Japanese. If you&rsquo;d like to read this article in English, please visit <a href=https://hackerone.com/reports/1032468 target=_blank>HackerOne report</a>.)</p><h2 id=tldr>TL;DR</h2><p>Twitterが公開したフリート機能が使用しているAPIに脆弱性が存在し、<code>READ</code>権限しか持っていないサードパーティアプリケーションがフリートの作成や削除などを行えた。</p><h2 id=調査したきっかけ>調査したきっかけ</h2><p>Twitterは2020年11月10日に、<a href=https://blog.twitter.com/ja_jp/topics/product/2020/ntroducing-fleets-new-way-to-join-the-conversation-jp.html target=_blank>フリート</a>と呼ばれる機能を日本に対して公開した。<br>当初はiOS版のクライアントのみに実装されたが、翌日の11日には手元のAndroid端末にフリート機能用の更新が降ってきていたため、APIを解析してみることにした。</p><h2 id=解析>解析</h2><p>Twitter for Androidは通常のAndroidアプリと同じくJavaで書かれており、難読化はされているものの解析はそこまで難しくない。<br>そのため、<a href=https://ibotpeaches.github.io/Apktool/ target=_blank><code>apktool</code></a>と<a href=https://github.com/pxb1988/dex2jar target=_blank><code>dex2jar</code></a>、<a href=https://www.benf.org/other/cfr/ target=_blank><code>CFR</code></a>を用いてデコンパイルし、ある程度可読性が高い状態に戻した。(詳細なデコンパイル方法に関してはここでは触れないが、ググれば出てくるのでそちらを参照してほしい。)<br>エンドポイント名がわからなければAPIを解析できないため、<code>grep</code>を用いて<code>fleet</code>という文字列が含まれる<code>.java</code>ファイルを検索し、<code>/fleet/v1/user_fleets</code>という文字列が含まれるファイルを発見した。<br>そのファイルと同じ階層にあるファイルを調べた所、他のエンドポイントと思わしき文字列が見つかったため、一旦それらを解析し、Gistにまとめた。</p><h2 id=検証中に>検証中に&mldr;</h2><p>その後、Gistの内容を精査している際に、サードパーティのアプリケーションとして認証している際にフリート関連のAPIを叩くと、問題なく動作することがわかった。<br>この事をドキュメントにまとめて公開すれば非公式クライアントの製作者の方が喜ぶのでは？と思い<a href=https://gist.github.com/Ry0taK/005b79eccb4297469a09696dae9fa3c6 target=_blank>詳細なAPIドキュメント</a>を書いた。<br>公開する前にこのGistの内容が間違っていないか検証していた所、<code>POST /fleets/v1/create</code>に対して読み取り権限しか持たないアプリケーションとしてリクエストを送信した際に、フリートが作成されてしまっていることがわかった。<br><img class=img-zoomable src=/img/fleet_from_api.png alt=APIから作ったフリートの画像></p><h2 id=これは脆弱性なのか>これは脆弱性なのか？</h2><p>最初は検証用アプリケーションに誤って書き込み権限を与えてしまったのだと思い、権限を確認したが、明らかに読み取り権限しか与えられていなかった。<br>この時点で、これは脆弱性なのでは？と思い始めたが、確証が得られなかったのでもう少し深く調査することにした。<br>その結果、通常のTwitterのAPI(<code>POST /1.1/statuses/update.json</code>等)では、APIの処理が走る前に権限チェックをしていたが(当たり前だが)、どうやらフリート関連のエンドポイントは通常のAPIでは行われる権限チェックが行われていないことが判明した。</p><pre><code class=language-bash>$ twurl /1.1/statuses/update.json --header 'Content-Type: application/json' -d '{&quot;status&quot;:&quot;Test&quot;}'
{&quot;request&quot;:&quot;\/1.1\/statuses\/update.json&quot;,&quot;error&quot;:&quot;Read-only application cannot POST.&quot;}

$ twurl /fleets/v1/create -X POST --header 'Content-Type: application/json' -d '{&quot;text&quot;:&quot;Hey yo&quot;}'
{&quot;fleet&quot;:{&quot;created_at&quot;:&quot;2020-11-12T12:29:16.180000000Z&quot;,&quot;deleted_at&quot;:null,&quot;expiration&quot;:&quot;2020-11-13T12:29:16.189235445Z&quot;,&quot;fleet_id&quot;:&quot;F1-328253875041691174&quot;,&quot;fleet_thread_id&quot;:&quot;T1-328253875041625638&quot;,&quot;mentions&quot;:null,&quot;mentions_str&quot;:null,&quot;read&quot;:false,&quot;text&quot;:&quot;Hey yo&quot;,&quot;user_id&quot;:1195137762027962368},&quot;fleet_thread_id&quot;:&quot;T1-328253875041625638&quot;,&quot;fleet_id&quot;:&quot;F1-328253875041691174&quot;,&quot;users&quot;:null}
</code></pre><h2 id=報告>報告</h2><p>脆弱性であることがわかったため、一旦フリート関連のAPIドキュメントの公開を見送り、Twitterに報告することにした。<br>報告は11月12日に行ったのだが、11月18日(実際にはもう数日前だったのだと思う)には修正されており、非常に印象的な修正速度だった。<br>しかしながら、残念なことにフリート関連のAPIがサードパーティのアプリケーションによって使用できていた事自体が問題だったようで、フリート関連のAPIをサードパーティのアプリケーションに叩かせないように変更することで修正されてしまった。</p><h2 id=その後>その後</h2><p>Twitterが脆弱性を修正した3日後、同じくフリートのAPIを解析してフリートの画像が24時間経った後もCDNから削除されない事を<a href=https://twitter.com/donk_enby/status/1330078983350837248 target=_blank>ツイート</a>している人がおり、フリート機能の実装に使えた期間はとても短かったのかな、と少しTwitter内部の開発者がかわいそうになってしまった。</p><blockquote class=twitter-tweet data-twitter-extracted-i1610455177818436366=true><p lang=en dir=ltr>i have also just confirmed that the media URLs don't expire after 24h, so you can view fleets after they're deleted</p>— 波兰蠢驴 (@donk_enby) <a href="https://twitter.com/donk_enby/status/1330078983350837248?ref_src=twsrc%5Etfw">November 21, 2020</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script>この脆弱性を発見する理由となったGistに関しては、[ここで公開](https://gist.github.com/Ry0taK/005b79eccb4297469a09696dae9fa3c6)しているので何かの役にたててほしい。<h2 id=まとめ>まとめ</h2><p>この一連の流れで、新機能を解析することの重要さと、どんな大企業でもミスはするという教訓を得ることが出来た。<br>Twitterに報告した際の実際のレポートは<a href=https://hackerone.com/reports/1032468 target=_blank>ここ</a>から見れるので是非読んでみてほしい。</p><p>このブログ記事に関して、なにか質問等がある場合は<a href=https://twitter.com/ryotkak target=_blank>Twitter(@ryotkak)</a>へDMを飛ばしてください。</p><h2 id=タイムライン>タイムライン</h2><table><thead><tr><th>日付</th><th>出来事</th></tr></thead><tbody><tr><td>2020/11/10</td><td>Twitterがフリート機能を日本向けにリリース</td></tr><tr><td>2020/11/11</td><td>手元の環境でフリート機能が使えるようになった</td></tr><tr><td>2020/11/12</td><td>脆弱性を発見、報告</td></tr><tr><td>2020/11/13</td><td>Twitter: 現在確認中</td></tr><tr><td>2020/11/14</td><td>Twitter: 脆弱性として認定</td></tr><tr><td>2020/11/18</td><td>Twitter: 脆弱性を修正</td></tr><tr><td>2020/12/15</td><td>Twitter: 報奨金額の決定</td></tr><tr><td>2021/01/05</td><td>脆弱性の開示</td></tr></tbody></table></div></article></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>ページ</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/about/>About</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>タグ</h3><div><span><a href=/tags/brute-force/>Brute Force</a></span>
<span><a href=/tags/bug-bounty/>Bug Bounty</a></span>
<span><a href=/tags/fleet/>Fleet</a></span>
<span><a href=/tags/idor/>IDOR</a></span>
<span><a href=/tags/microsoft/>Microsoft</a></span>
<span><a href=/tags/privilege-escalation/>Privilege Escalation</a></span>
<span><a href=/tags/rce/>RCE</a></span>
<span><a href=/tags/timing-attack/>Timing Attack</a></span>
<span><a href=/tags/twitter/>Twitter</a></span>
<span><a href=/tags/vscode/>VSCode</a></span></div></div><div class="sidebar-item sidebar-links"><h3>リンク</h3><ul><li><a href=https://twitter.com/ryotkak target=_blank><span>Twitter</span></a></li><li><a href=https://github.com/Ry0taK target=_blank><span>GitHub</span></a></li></ul></div></aside></div><div class=btn><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021 <a href=https://blog.ryotak.me>RyotaK</a> |
Powered by <a href=https://github.com/amzrk2/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/combine/npm/medium-zoom@1.0.6,npm/lazysizes@5.2.2></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script></body></html>